#!/usr/bin/env node
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const MAPPINGS_PATH = path.join(__dirname, '..', '.venue-image-mappings.json');
const APP_VENUES_JS = path.join(__dirname, '..', 'bassline-app', 'src', 'data', 'venues.js');
const WEB_VENUES_TS = path.join(__dirname, '..', 'bassline-web', 'src', 'data', 'venues.ts');
const APP_VENUE_IMAGES_JS = path.join(__dirname, '..', 'bassline-app', 'src', 'data', 'venueImages.js');

// Helper to normalize venue name to key format
function nameToKey(name) {
  return name
    .replace(/'s\b/gi, 's')
    .replace(/[^A-Za-z0-9]+/g, '_')
    .replace(/^_|_$/g, '');
}

// Update app venueImages.js
function updateAppVenueImages(mappings) {
  console.log('üì± Updating app venueImages.js...');
  
  let content = `// Auto-generated by scripts/update-venue-data.mjs
// Note: @venue-images alias should resolve to ../venue-images from this file's location
export const venueImages = {
`;

  // Sort by venue name for consistency
  const sortedKeys = Object.keys(mappings).sort();
  
  for (const key of sortedKeys) {
    const mapping = mappings[key];
    const category = mapping.category;
    
    if (mapping.images.length === 0) continue;

    const heroImage = mapping.images[0];
    const galleryImages = mapping.images;

    content += `  "${key}": {\n`;
    content += `    hero: require('@venue-images/${category}/${heroImage.original}'),\n`;
    content += `    gallery: [\n`;
    galleryImages.forEach(img => {
      content += `      require('@venue-images/${category}/${img.original}'),\n`;
    });
    content += `    ],\n`;
    content += `  },\n`;
  }

  content += `};

export function nameToImageKey(name) {
  if (!name) return '';
  return name
    .replace(/'s\\b/gi, 's')
    .replace(/[^A-Za-z0-9]+/g, '_')
    .replace(/^_|_$/g, '');
}
`;

  fs.writeFileSync(APP_VENUE_IMAGES_JS, content);
  console.log(`   ‚úì Updated ${sortedKeys.length} venue image mappings`);
}

// Update app venues.js
function updateAppVenues(mappings) {
  console.log('üì± Updating app venues.js...');
  
  let content = fs.readFileSync(APP_VENUES_JS, 'utf-8');
  
  // Import venueImages if not already imported
  if (!content.includes("import { venueImages, nameToImageKey }")) {
    const importLine = "import { venueImages, nameToImageKey } from './venueImages';\n\n";
    content = importLine + content;
  }

  // Update each venue's heroImage and gallery
  for (const [key, mapping] of Object.entries(mappings)) {
    const venueId = mapping.venueId;
    
    // Find venue by ID in the content
    const venuePattern = new RegExp(
      `(\\{[\\s\\S]*?"id":\\s*${venueId}[\\s\\S]*?"name":\\s*"${mapping.venueName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"[\\s\\S]*?)"heroImage":\\s*[^,}]+`,
      'm'
    );
    
    if (venuePattern.test(content)) {
      content = content.replace(
        venuePattern,
        `$1"heroImage": venueImages[nameToImageKey('${mapping.venueName}')]?.hero || require('../../assets/icon.png')`
      );
    }

    // Update gallery
    const galleryPattern = new RegExp(
      `(\\{[\\s\\S]*?"id":\\s*${venueId}[\\s\\S]*?"name":\\s*"${mapping.venueName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"[\\s\\S]*?)"gallery":\\s*\\[[^\\]]*\\]`,
      'm'
    );
    
    if (galleryPattern.test(content)) {
      content = content.replace(
        galleryPattern,
        `$1"gallery": venueImages[nameToImageKey('${mapping.venueName}')]?.gallery || []`
      );
    } else {
      // Add gallery if it doesn't exist
      const addGalleryPattern = new RegExp(
        `(\\{[\\s\\S]*?"id":\\s*${venueId}[\\s\\S]*?"name":\\s*"${mapping.venueName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"[\\s\\S]*?)(\\s*\\}[\\s,])`,
        'm'
      );
      
      if (addGalleryPattern.test(content)) {
        content = content.replace(
          addGalleryPattern,
          `$1,\n    "gallery": venueImages[nameToImageKey('${mapping.venueName}')]?.gallery || []$2`
        );
      }
    }
  }

  fs.writeFileSync(APP_VENUES_JS, content);
  console.log(`   ‚úì Updated app venues.js`);
}

// Update web venues.ts
function updateWebVenues(mappings) {
  console.log('üåê Updating web venues.ts...');
  
  let content = fs.readFileSync(WEB_VENUES_TS, 'utf-8');
  
  // Update each venue's heroImage and gallery
  for (const [key, mapping] of Object.entries(mappings)) {
    const venueId = mapping.venueId;
    const venueSlug = mapping.images[0]?.web?.replace('-hero.jpg', '').replace('-hero.jpeg', '').replace('-hero.png', '') || '';
    
    if (!venueSlug) continue;

    // Update heroImage
    const heroPattern = new RegExp(
      `(\\{[\\s\\S]*?"id":\\s*${venueId}[\\s\\S]*?"name":\\s*"${mapping.venueName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"[\\s\\S]*?)"heroImage":\\s*"[^"]*"`,
      'm'
    );
    
    if (heroPattern.test(content)) {
      const heroImage = mapping.images[0]?.web || `${venueSlug}-hero.jpg`;
      content = content.replace(
        heroPattern,
        `$1"heroImage": "/images/venues/${heroImage}"`
      );
    }

    // Update gallery
    const galleryImages = mapping.images.slice(1).map(img => img.web).filter(Boolean);
    if (galleryImages.length > 0) {
      const galleryList = galleryImages.map(img => `"/images/venues/${img}"`).join(',\n      ');
      
      const galleryPattern = new RegExp(
        `(\\{[\\s\\S]*?"id":\\s*${venueId}[\\s\\S]*?"name":\\s*"${mapping.venueName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"[\\s\\S]*?)"gallery":\\s*\\[[^\\]]*\\]`,
        'm'
      );
      
      if (galleryPattern.test(content)) {
        content = content.replace(
          galleryPattern,
          `$1"gallery": [\n      ${galleryList}\n    ]`
        );
      } else {
        // Add gallery if it doesn't exist
        const addGalleryPattern = new RegExp(
          `(\\{[\\s\\S]*?"id":\\s*${venueId}[\\s\\S]*?"name":\\s*"${mapping.venueName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"[\\s\\S]*?)(\\s*\\}[\\s,])`,
          'm'
        );
        
        if (addGalleryPattern.test(content)) {
          content = content.replace(
            addGalleryPattern,
            `$1,\n    "gallery": [\n      ${galleryList}\n    ]$2`
          );
        }
      }
    }
  }

  fs.writeFileSync(WEB_VENUES_TS, content);
  console.log(`   ‚úì Updated web venues.ts`);
}

// Main function
function main() {
  console.log('üîÑ Updating venue data files...\n');

  if (!fs.existsSync(MAPPINGS_PATH)) {
    console.error('‚ùå Error: .venue-image-mappings.json not found. Run sync-venue-images.mjs first.');
    process.exit(1);
  }

  const mappings = JSON.parse(fs.readFileSync(MAPPINGS_PATH, 'utf-8'));

  updateAppVenueImages(mappings);
  updateAppVenues(mappings);
  updateWebVenues(mappings);

  console.log('\n‚úÖ Venue data files updated!');
}

main();

