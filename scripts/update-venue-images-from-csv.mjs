import fs from 'fs';
import path from 'path';

const csvPath = path.join(process.cwd(), 'FINAL Database - Bars-2.csv');
const clubsCsvPath = path.join(process.cwd(), 'FINAL Database - Clubs-2.csv');
const munchiesCsvPath = path.join(process.cwd(), 'FINAL Database - Munchies-2.csv');
const venueImagesPath = path.join(process.cwd(), 'src/data/venueImages.js');

function parseCSV(csvContent) {
  const lines = csvContent.split('\n').filter(line => line.trim());
  const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
  const rows = lines.slice(1).map(line => {
    const values = line.split(',').map(v => v.replace(/"/g, '').trim());
    const obj = {};
    headers.forEach((header, i) => {
      obj[header] = values[i] || '';
    });
    return obj;
  });
  return rows;
}

function getAvailableImages(venueName, folder) {
  const imageDir = path.join(process.cwd(), 'venue-images', folder);
  const files = fs.readdirSync(imageDir).filter(file =>
    file.startsWith(`${venueName}_`) &&
    (file.endsWith('.jpg') || file.endsWith('.jpeg') || file.endsWith('.png') || file.endsWith('.webp'))
  );

  // Prioritize venue images over food images
  const venueImages = files.filter(file => file.includes('_venue_'));
  const otherImages = files.filter(file => !file.includes('_venue_') && !file.includes('_food_'));

  let selectedFiles = venueImages.length > 0 ? venueImages : otherImages;

  // If still no images, include food images as fallback
  if (selectedFiles.length === 0) {
    selectedFiles = files.filter(file => file.includes('_food_'));
  }

  // If still no images, use all available
  if (selectedFiles.length === 0) {
    selectedFiles = files;
  }

  const images = selectedFiles.map(file => {
    const numMatch = file.match(/_(\d+)\./);
    if (numMatch) {
      return { num: parseInt(numMatch[1]), filename: file };
    }
    // Fallback for files without numbers
    return { num: 999, filename: file };
  }).sort((a, b) => a.num - b.num);

  return images;
}

// Mapping for venue names that don't match exactly between CSV and image files
const nameMapping = {
  // Bars
  "Gigi's": "Gigi's Wine Lounge",
  "Hi‑Tops": "Hi-Tops",
  "Palm City": "Palm City Wines",
  "Make‑Out Room": "Make-Out Room",
  // Clubs
  // Munchies
  "Pinecrest": "Pinecrest Diner",
  "Taishan": "Taishan Cuisine",
  "Grubstake": "Grubstake Diner",
  "Hinodeya": "Hinodeya Ramen Bar",
  "Sam's": "Sams",
};

function getImageName(venueName) {
  return nameMapping[venueName] || venueName;
}

function generateVenueImageEntry(venueName, folder) {
  const imageName = getImageName(venueName);
  const images = getAvailableImages(imageName, folder);

  if (images.length === 0) {
    console.warn(`No images found for ${venueName} (searched as: ${imageName}) in ${folder}`);
    return null;
  }

  // Use the first image as hero, and all images for gallery
  const heroImage = images[0].filename;
  const galleryImages = images.map(img => img.filename);

  return {
    hero: `@venue-images/${folder}/${heroImage}`,
    gallery: galleryImages.map(img => `@venue-images/${folder}/${img}`)
  };
}

function main() {
  // Read CSV files
  const barsCsv = fs.readFileSync(csvPath, 'utf8');
  const clubsCsv = fs.readFileSync(clubsCsvPath, 'utf8');
  const munchiesCsv = fs.readFileSync(munchiesCsvPath, 'utf8');

  // Parse venues
  const bars = parseCSV(barsCsv);
  const clubs = parseCSV(clubsCsv);
  const munchies = parseCSV(munchiesCsv);

  console.log(`Found ${bars.length} bars, ${clubs.length} clubs, ${munchies.length} munchies`);

  // Generate venue images object
  const venueImages = {};

  // Process bars
  bars.forEach(venue => {
    const entry = generateVenueImageEntry(venue.Name, 'Bars 2');
    if (entry) {
      venueImages[venue.Name] = entry;
    }
  });

  // Process clubs
  clubs.forEach(venue => {
    const entry = generateVenueImageEntry(venue.Name, 'Clubs 2');
    if (entry) {
      venueImages[venue.Name] = entry;
    }
  });

  // Process munchies
  munchies.forEach(venue => {
    const entry = generateVenueImageEntry(venue.Name, 'Munchies 2');
    if (entry) {
      venueImages[venue.Name] = entry;
    }
  });

  // Generate the JavaScript file content
  let content = '// Auto-generated by scripts/update-venue-images-from-csv.mjs\nexport const venueImages = {\n';

  Object.keys(venueImages).sort().forEach(venueName => {
    const entry = venueImages[venueName];
    content += `  "${venueName}": {\n`;
    content += `    hero: require('${entry.hero}'),\n`;
    content += `    gallery: [\n`;
    entry.gallery.forEach(img => {
      content += `      require('${img}'),\n`;
    });
    content += `    ],\n`;
    content += `  },\n`;
  });

  content += '};\n';

  // Write the file
  fs.writeFileSync(venueImagesPath, content, 'utf8');
  console.log(`Updated ${venueImagesPath} with ${Object.keys(venueImages).length} venues`);
}

main();
